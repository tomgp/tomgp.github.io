<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="/scripts/d3.v3.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Book shelf</title>
	<style>
		body {
			background-color: #000;
			font-family: sans-serif;
			color: #FFF;
		}

		.input {}

		rect {
			shape-rendering:crispEdges;
		}

		rect:hover {
			stroke: #FFF;
			stroke-width: 3;
			stroke-dasharray: 5, 5;
		}

		.info {
			position: fixed;
			top: 0px;
			right: 0px;
			width: 25%;
			background-color: rgba(0, 0, 0, 0.5);
		}
	</style>
</head>
<body>
<div class="vis"></div>
<div class="input">
<div>Key</div>
	Filter

</div>
<div class="info"></div>
</body>
<script>
	'use strict';
	var shelfHeight = 100;
	var nomalSpacing = 4;
	var pageWidth = 0.06;

	var settings = {
		highlight: 'age-of-book',//'rating', ////'age-of-book',  
		search: null,
	};


	function colourBook(d){
		//if highlighted by rating
		var ratingScale = d3.scale.ordinal()
			.domain(['++', '+', '', '-', '--'])
			.range(['#0f0', '#ff0', '#fff', '#999', '#333'] );

		var ageHighlight = d3.scale.threshold()
		    .domain([1,10,25,100, 500, 3000])
		    .range(['#fff','#bfd3e6','#9ebcda','#8c96c6','#88419d','#6e016b']);

		if(settings.highlight == 'age-of-book'){
			return ageHighlight( d.data.date.getFullYear() - Number(d.data.published) );
		}else if(settings.highlight == 'rating'){
			return ratingScale( d.data.rating );
		}

		return '#FFF';
	}


	d3.csv('/data/books.csv', function(data){
		//SORT OUT THE DATA
		var sortOn = {
			date: function(a,b){ return b.date.getTime() - a.date.getTime(); }
		}

		var sheetDateFormat = d3.time.format("%Y-%m-%d");

		data = data.map(function(d){
			if(d.date){
				d.read = true;
				d.date = sheetDateFormat.parse(d.date);
			}else{
				d.read = false;
			}
			d.pages = Number(d.pages);
			return d;
		});

		var years = splitOn(data, function(d){
			if(d.date){
				return d.date.getFullYear();
			}
			return 'on the stack';
		});

		years = Object.keys(years).map(function(y){
			var books = data.filter(function(d){
				if(d.date){
					return (d.date.getFullYear() == y);
				}
				return false;
			});

			return {
				year: y,
				books: shelfLayout( books, pageWidth, nomalSpacing), 
				pageCount: d3.sum(books, function(b){ return b.pages; })
			};
		});

		var max = years.reduce(function(prev, cur, i, a){
			return {
				books: Math.max(prev.books, cur.books.length),
				pages: Math.max(prev.pages, cur.pageCount),
			};
		}, {books:0, pages:0});

		var width = (max.pages * pageWidth) + (max.books * nomalSpacing);

		//DRAW THE STUFF

		d3.select('.vis')
			.append('svg')
				.attr({
					height: years.length * shelfHeight,
					width: (max.pages * pageWidth) + (max.books * nomalSpacing)
				})
			.selectAll('g.shelf')
				.data(years
						.reverse()
						.filter(function(d){ 
							return (d.year != 'on the stack')
						})
				)
				.enter()
			.append('g')
				.attr({
					class:'shelf',
					transform:function(d,i){
						return 'translate(5,' + (i * shelfHeight) + ')';
					}
				})
			.call(function(shelf){
				shelf.selectAll('g').attr('id',function(){
						return 'shelf' + d.year;
					})
					.data(function(d){ return  d.books; })
						.enter()
					.append('g')
						.call(function(g){
							g.attr('transform',function(d){
								return 'translate(' + d.x + ',0)'}
							);

							g.append('rect')
								.attr({
									x: 0,
									y: function(d){
										if(d.data.comic) return shelfHeight -(shelfHeight*0.9);
										return shelfHeight - (shelfHeight*0.75);
									},
									width: function(d){ return d.width; },
									height: function(d){
										if(d.data.comic) return shelfHeight*0.9
										return shelfHeight*0.75
									},
									fill: colourBook,
								}).on('click',function(d){
									showInfo( [d.data] );
								});
						});
			})

	});

function showInfo(data){
	var join = d3.select('.info')
		.selectAll('div')
		.data(data)

	join.enter().append('div')
	join.exit().remove();
	join.html(function(d){
	console.log(d); 
		return '<h2>'+d.title+'</h2>' +
			'<p>by '+d.authors+' </p>';
//		return JSON.stringify(d); 
	});

}

function shelfLayout(s, thickness, spacing){
	var acc = 0;

	return s.map(function(d){
		var o = {
			data: d,
			x: Math.floor(acc),
			width: Math.max( Math.floor( d.pages*thickness ), spacing)
		};
		acc += (o.width + spacing);
		return o;
	});
}

function splitOn(array, keyFunction){
	if(!keyFunction) keyFunction = function(d,i){ return i; };
	var splitUp = {};
	
	array.forEach(function(d,i){
		var key = keyFunction(d,i);
		if(!splitUp[key]) splitUp[key] = [];
		splitUp[key].push(d);
	})
	return splitUp;
}
</script>
</html>